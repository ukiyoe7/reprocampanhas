## NOVO MODELO APURACAO CAMPANHAS
## PERIODO DE REFERENCIA 0522
## SANDRO JAKOSKA

library(DBI)
library(tidyverse)
library(lubridate)
library(googlesheets4)
con2 <- dbConnect(odbc::odbc(), "reproreplica")


## G139 SCHROEDER
# Rebate 7% para vendedoras e 3% para montador

CP_G139_0522 <-dbGetQuery(con2,"
WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','SR','R')),

CLI AS(SELECT C.CLICODIGO,GCLCODIGO,CLINOMEFANT,SETOR FROM CLIEN C
       LEFT JOIN (SELECT CLICODIGO,D.ZOCODIGO,ZODESCRICAO SETOR FROM ENDCLI D
       INNER JOIN ZONA Z ON D.ZOCODIGO=Z.ZOCODIGO WHERE ENDFAT='S')A ON C.CLICODIGO=A.CLICODIGO
       WHERE GCLCODIGO=139),

PD AS (SELECT ID_PEDIDO,PEDDTBAIXA,PEDID.CLICODIGO,CLINOMEFANT,SETOR,GCLCODIGO,PEDAUTORIZOU 
       FROM PEDID 
       INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
       INNER JOIN CLI ON PEDID.CLICODIGO=CLI.CLICODIGO
       WHERE PEDDTBAIXA BETWEEN
       '01.05.2022' AND '31.05.2022'
      AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N'))


SELECT 
 PDPRD.ID_PEDIDO,
  PEDDTBAIXA,
   CLICODIGO,
    GCLCODIGO,
     SETOR,
     PROCODIGO,
      PDPDESCRICAO,
       PEDAUTORIZOU,
       SUM(PDPQTDADE) QTD,
       SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
       SUM(PDPUNITLIQUIDO*PDPQTDADE)*0.07 BONUS
       FROM
       PDPRD
       INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
       GROUP BY 1,2,3,4,5,6,7,8") 

View(CP_G139_0522)
CP_G139_0522 %>%  summarize(v=sum(VRVENDA)) # total sales
CP_G139_0522 %>%  summarize(v=sum(VRVENDA)*0.07) # vendedoras 
CP_G139_0522 %>%  summarize(v=sum(VRVENDA)*0.03) # montador
sum(CP_G139_0522 %>%  summarize(v=sum(VRVENDA)*0.07),CP_G139_0522 %>% summarize(v=sum(VRVENDA)*0.03)) #total

### Cria Planilha identificação CPFs

CP_G139_0522_IPEDIDOS <- CP_G139_0522 %>% group_by(ID_PEDIDO,PEDDTBAIXA) %>% 
  summarize(VRVENDA=sum(VRVENDA)) %>% 
  as.data.frame() %>% `colnames<-`(c("ID_PEDIDO","DATA","VALOR.VENDA")) %>% 
  mutate(DATA=format(DATA,"%d/%m/%y")) 

range_write("18h6_9wuKTIl3S9iVLjHH8mHbVcIFO8Mi_i9XcID8bE0",data=CP_G139_0522_IPEDIDOS,sheet = "MAI22",
            range = "A1") 


View(CP_G139_0522_IPEDIDOS)

## obtem dados planilha identificação CPFs


CPF_G139_CPF_0522 <- read_sheet("18h6_9wuKTIl3S9iVLjHH8mHbVcIFO8Mi_i9XcID8bE0",sheet = "MAI22") %>% 
  as.data.frame() %>% 
  mutate(CPF=sub("\\D+", '',CPF)) %>% 
  mutate(CPF=sub("\\.", '',CPF)) %>% 
  mutate(CPF=sub("\\-", '',CPF))

View(CPF_G139_CPF_0522)


#lista pedidos

LIST_G139_0522 <- inner_join(CP_G139_0522,CPF_G139_CPF_0522,by="ID_PEDIDO") %>% 
  mutate(OBS="SCHROEDER G139 05/22") %>% .[,c(-12,-13,-14)]

View(LIST_G139_0522)

LIST_G139_0422 %>% summarize(BONUS=sum(BONUS)) 

### pagamentos


# Calculo vendedoras

PAG_G139_0522_VENDEDORAS <- LIST_G139_0522 %>% group_by(CPF) %>% summarize(BONUS=sum(BONUS)) 

#calculo com montador

PAG_G139_0522_MONTADOR <- data.frame(CPF=c("88717020930"),BONUS=(CP_G139_0522 %>% 
                                                                   summarize(BONUS=sum(VRVENDA)*0.03))) 


PAG_G139_0522 <- rbind(PAG_G139_0522_VENDEDORAS,PAG_G139_0522_MONTADOR)  %>% 
  mutate(OBS="SCHROEDER G139 05/22") %>%  mutate(CLIENTE='') %>%  mutate(GRUPO='139') 

View(PAG_G139_0522)

PAG_G139_0522 %>% summarize(BONUS=sum(BONUS)) 


## ============================================================================================

## SQL 849 VITAL

CP_849_0522 <- dbGetQuery(con2,"
WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','SR','R')),

CLI AS(SELECT C.CLICODIGO,GCLCODIGO, CLINOMEFANT,SETOR FROM CLIEN C
       LEFT JOIN (SELECT CLICODIGO,D.ZOCODIGO,ZODESCRICAO SETOR FROM ENDCLI D
       INNER JOIN ZONA Z ON D.ZOCODIGO=Z.ZOCODIGO WHERE ENDFAT='S')A ON C.CLICODIGO=A.CLICODIGO
       WHERE C.CLICODIGO=849),

PD AS (SELECT ID_PEDIDO,PEDDTBAIXA,PEDID.CLICODIGO,GCLCODIGO,CLINOMEFANT,SETOR,PEDAUTORIZOU 
       FROM PEDID 
       INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
       INNER JOIN CLI ON PEDID.CLICODIGO=CLI.CLICODIGO
       WHERE PEDDTBAIXA BETWEEN '01.05.2022' AND '31.05.2022'
      AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N'))


SELECT 
      PDPRD.ID_PEDIDO,
       PEDDTBAIXA,
        CLICODIGO,
         GCLCODIGO,
          SETOR,
           PROCODIGO,
            PDPDESCRICAO,
             PEDAUTORIZOU,
              SUM(PDPQTDADE) QTD,
               SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
                SUM(PDPUNITLIQUIDO*PDPQTDADE)*0.07 BONUS
                 FROM
                 PDPRD
                 INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
                 GROUP BY 1,2,3,4,5,6,7,8") 

View(CP_849_0522)

CP_849_0522 %>% summarize(v=sum(VRVENDA))

CP_849_0522 %>% summarize(v=sum(VRVENDA)*0.08)

## LISTA PEDIDOS
LIST_849_0522 <- CP_849_0522 %>% 
  mutate(CPF=rep(c("04455447911","06532582913"), length.out=nrow(CP_849_0522)))  
  

View(LIST_849_0522)

## PAGAMENTOS 

PAG_849_0522 <- LIST_849_0522 %>% group_by(CLICODIGO,CPF) %>% 
                    summarize(BONUS=round(sum(BONUS)/2,2)) %>% mutate(OBS="VITAL 849 05/22")


View(PAG_849_0522)



### ===========================================================================================

## SQL 157 DOMBOSCO

CP_157_0522 <- dbGetQuery(con2,"
WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','SR','R')),

CLI AS(SELECT C.CLICODIGO,GCLCODIGO,CLINOMEFANT,SETOR FROM CLIEN C
       LEFT JOIN (SELECT CLICODIGO,D.ZOCODIGO,ZODESCRICAO SETOR FROM ENDCLI D
       INNER JOIN ZONA Z ON D.ZOCODIGO=Z.ZOCODIGO WHERE ENDFAT='S')A ON C.CLICODIGO=A.CLICODIGO
       WHERE C.CLICODIGO=157),

PD AS (SELECT ID_PEDIDO,PEDDTBAIXA,PEDID.CLICODIGO,GCLCODIGO,CLINOMEFANT,SETOR,PEDAUTORIZOU 
       FROM PEDID 
       INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
       INNER JOIN CLI ON PEDID.CLICODIGO=CLI.CLICODIGO
       WHERE PEDDTBAIXA BETWEEN  '01.05.2022' AND '31.05.2022'
      AND PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N'))


SELECT 
      PDPRD.ID_PEDIDO,
       PEDDTBAIXA,
        CLICODIGO,
         GCLCODIGO,
          SETOR,
           PROCODIGO,
            PDPDESCRICAO,
             PEDAUTORIZOU,
              SUM(PDPQTDADE) QTD,
               SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
                SUM(PDPUNITLIQUIDO*PDPQTDADE)*0.1 BONUS
                 FROM
                 PDPRD
                 INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
                 GROUP BY 1,2,3,4,5,6,7,8") 

View(CP_157_0522)

CP_157_0522 %>% summarize(v=sum(VRVENDA))

CP_157_0522 %>% summarize(v=sum(VRVENDA)*0.1)


## lista pedidos 
LIST_157_0522 <- CP_157_0522 %>% 
  mutate(CPF=rep(c("03188282940"), length.out=nrow(CP_157_0522))) %>% mutate(OBS="DOM BOSCO 157 05/22")


View(LIST_157_0522)

LIST_157_0522 %>% summarize(v=sum(BONUS))


LIST_157_0522 %>% group_by(CLICODIGO,CPF) %>% summarize(BONUS=round(sum(BONUS),2)) %>% 
  mutate(DATA=floor_date(Sys.Date(),"month") %m-% months(1)) 


## Pagamento

PAG_157_0522 <- LIST_157_0522 %>% group_by(CLICODIGO,CPF) %>% summarize(BONUS=round(sum(BONUS),2)) %>% 
                  mutate(OBS="DOM BOSCO 157 05/22")  

View(PAG_157_0522)



### ===========================================================================================

##  SQL 1419 OTICA LOOK 

CP_1419_0522 <- dbGetQuery(con2,"
WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','SR','R')),

CLI AS(SELECT C.CLICODIGO,CLINOMEFANT,GCLCODIGO,SETOR FROM CLIEN C
       LEFT JOIN (SELECT CLICODIGO,D.ZOCODIGO,ZODESCRICAO SETOR FROM ENDCLI D
       INNER JOIN ZONA Z ON D.ZOCODIGO=Z.ZOCODIGO WHERE ENDFAT='S')A ON C.CLICODIGO=A.CLICODIGO
       WHERE C.CLICODIGO=1419),

PD AS (SELECT ID_PEDIDO,PEDDTBAIXA,PEDID.CLICODIGO,GCLCODIGO,CLINOMEFANT,SETOR,PEDAUTORIZOU 
       FROM PEDID 
       INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
       INNER JOIN CLI ON PEDID.CLICODIGO=CLI.CLICODIGO
       WHERE 
       PEDDTBAIXA BETWEEN '01.05.2022' AND '31.05.2022' AND PEDSITPED <>'C'),

PROD1 AS (SELECT PROCODIGO FROM PRODU WHERE MARCODIGO=159) ,-- AVANCE


PROD2 AS (SELECT PROCODIGO FROM PRODU WHERE MARCODIGO=128 AND LEFT(PROCODIGO,2)='LD') -- UZ+
  
  SELECT 
     PDPRD.ID_PEDIDO,
      PEDDTBAIXA,
       CLICODIGO,
        GCLCODIGO,
         SETOR,
          PDPRD.PROCODIGO,
           PDPDESCRICAO,
            PEDAUTORIZOU,
             SUM(PDPQTDADE)QTD,
              SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
               CAST(20 AS DECIMAL(10,2)) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD1 ON PDPRD.PROCODIGO=PROD1.PROCODIGO
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION

SELECT 
 PDPRD.ID_PEDIDO,
  PEDDTBAIXA,
   CLICODIGO,
    GCLCODIGO,
     SETOR,
      PDPRD.PROCODIGO,
       PDPDESCRICAO,
        PEDAUTORIZOU,
         SUM(PDPQTDADE)QTD,
          SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
           CAST(5 AS DECIMAL(10,2)) BONUS
          
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD2 ON PDPRD.PROCODIGO=PROD2.PROCODIGO
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2") 


View(CP_1419_0522)


CP_1419_0522 %>% summarize(v=sum(BONUS))

### lista pedidos  


LIST_1419_0522<- CP_1419_0522 %>% mutate(CPF=rep(c("47751118091"), length.out=nrow(CP_1419_0522))) %>% 
  mutate(OBS="1419 OTICA LOOK 05/21") 

View(LIST_1419_0522)


### pagamentos  

PAG_1419_0522 <- LIST_1419_0522 %>%  group_by(CLICODIGO,CPF) %>% 
                             summarize(BONUS=round(sum(BONUS),2)) %>%
                               mutate(OBS="1419 OTICA LOOK 05/22")


View(PAG_1419_0522)

## ================================================================================

# SQL 305 GARUVA


CP_305_0522 <-dbGetQuery(con2,"
                           WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','SR','R')),

CLI AS(SELECT C.CLICODIGO,GCLCODIGO,CLINOMEFANT,SETOR FROM CLIEN C
       LEFT JOIN (SELECT CLICODIGO,D.ZOCODIGO,ZODESCRICAO SETOR FROM ENDCLI D
       INNER JOIN ZONA Z ON D.ZOCODIGO=Z.ZOCODIGO WHERE ENDFAT='S')A ON C.CLICODIGO=A.CLICODIGO WHERE C.CLICODIGO=305),

PD AS (SELECT ID_PEDIDO,PEDDTBAIXA,GCLCODIGO,SETOR,PEDID.CLICODIGO,CLINOMEFANT,PEDAUTORIZOU 
FROM PEDID 
INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
INNER JOIN CLI ON PEDID.CLICODIGO=CLI.CLICODIGO
WHERE PEDDTBAIXA BETWEEN '01.05.2022' AND '31.05.2022' AND PEDSITPED <>'C'),

PROD1 AS (SELECT PROCODIGO FROM PRODU WHERE MARCODIGO=159), -- AVANCE

PROD2 AS (SELECT PROCODIGO FROM PRODU WHERE MARCODIGO=158), -- ACTUALITE

PROD3 AS (SELECT PROCODIGO FROM PRODU WHERE MARCODIGO=128), -- UZ+

PROD4 AS (SELECT PROCODIGO FROM PRODU WHERE MARCODIGO=135) -- IMAGEM

SELECT  DISTINCT PDPRD.ID_PEDIDO,
          PEDDTBAIXA,
           CLICODIGO,
            GCLCODIGO,
             SETOR,
              PDPRD.PROCODIGO,
               PDPDESCRICAO,
                PEDAUTORIZOU,
                 SUM(PDPQTDADE)QTD,
                  SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
                   CAST(40 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD1 ON PDPRD.PROCODIGO=PROD1.PROCODIGO
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION

SELECT 
DISTINCT PDPRD.ID_PEDIDO,
          PEDDTBAIXA,
           CLICODIGO,
            GCLCODIGO,
             SETOR,
               PDPRD.PROCODIGO,
               PDPDESCRICAO,
                PEDAUTORIZOU,
                  SUM(PDPQTDADE)QTD,
                   SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
                    CAST(30 AS INTEGER) BONUS

FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD2 ON PDPRD.PROCODIGO=PROD2.PROCODIGO
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION

SELECT 
DISTINCT PDPRD.ID_PEDIDO,
PEDDTBAIXA,
CLICODIGO,
GCLCODIGO,
SETOR,
PDPRD.PROCODIGO,
PDPDESCRICAO,
 PEDAUTORIZOU,
SUM(PDPQTDADE)QTD,
SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
CAST(20 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD3 ON PDPRD.PROCODIGO=PROD3.PROCODIGO
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION

SELECT 
DISTINCT PDPRD.ID_PEDIDO,
PEDDTBAIXA,
CLICODIGO,
GCLCODIGO,
SETOR,
PDPRD.PROCODIGO,
PDPDESCRICAO,
PEDAUTORIZOU,
SUM(PDPQTDADE)QTD,
SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
CAST(10 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD4 ON PDPRD.PROCODIGO=PROD4.PROCODIGO
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2")  %>%  
  mutate(CPF=sub("\\D+", '',PEDAUTORIZOU)) %>% 
  mutate(CPF=sub("\\.", '',CPF)) %>% 
  mutate(CPF=sub("\\-", '',CPF))


View(CP_305_0522)

CP_305_0522 %>% summarize(v=sum(BONUS))


### lista pedidos

LIST_305_0522 <- CP_305_0522 %>% 
  mutate(CPF=rep(c("66655072972"), length.out=nrow(CP_305_0522))) %>% 
  mutate(OBS="305 OTICA GARUVA 05/22")

View(LIST_305_0522)


### pagamentos

PAG_305_0522 <- LIST_305_0522 %>% group_by(CPF) %>% 
                            summarize(BONUS=round(sum(BONUS),2)) %>% 
                              mutate(OBS="305 OTICA GARUVA 05/22")

View(PAG_305_0522)


PAG_305_0522 %>% summarize(v=sum(BONUS)) 



## =============================================================================================================         

# SQL G121 RINALDI

CP_G121_0522 <- dbGetQuery(con2,"
WITH FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','SR','R')),

CLI AS(SELECT C.CLICODIGO,CLINOMEFANT,GCLCODIGO,SETOR FROM CLIEN C
       LEFT JOIN (SELECT CLICODIGO,D.ZOCODIGO,ZODESCRICAO SETOR FROM ENDCLI D
       INNER JOIN ZONA Z ON D.ZOCODIGO=Z.ZOCODIGO WHERE ENDFAT='S')A ON 
       C.CLICODIGO=A.CLICODIGO WHERE GCLCODIGO=121),

PD AS (SELECT ID_PEDIDO,PEDDTBAIXA,PEDID.CLICODIGO,GCLCODIGO,SETOR,CLINOMEFANT,PEDAUTORIZOU  
FROM PEDID 
INNER JOIN FIS ON PEDID.FISCODIGO1=FIS.FISCODIGO
INNER JOIN CLI ON PEDID.CLICODIGO=CLI.CLICODIGO
WHERE PEDDTBAIXA BETWEEN '01.05.2022' AND '31.05.2022' AND PEDSITPED <>'C'),

PROD1 AS (SELECT PROCODIGO,PRODESCRICAO FROM PRODU WHERE MARCODIGO=57 AND (PRODESCRICAO LIKE '%X TRACK%' OR PRODESCRICAO LIKE '%4D%' OR PRODESCRICAO LIKE '%XCLUSIVE%')),

PROD2 AS (SELECT PROCODIGO,PRODESCRICAO FROM PRODU WHERE MARCODIGO=57 AND PRODESCRICAO LIKE '%X DESIGN%'),

PROD3 AS (SELECT PROCODIGO,PRODESCRICAO FROM PRODU WHERE MARCODIGO=57 AND PRODESCRICAO LIKE '%E DESIGN%'),

PROD4 AS (SELECT PROCODIGO,PRODESCRICAO FROM PRODU WHERE MARCODIGO=57 AND (PRODESCRICAO LIKE '%COMFORT%' OR PRODESCRICAO LIKE '%LIBERTY%') AND LEFT(PROCODIGO,2)='LD'),
 
PED_PROMO_PAP AS (SELECT P.ID_PEDIDO ID_PEDIDO_PROMO FROM PDPRD P
 INNER JOIN PD ON P.ID_PEDIDO=PD.ID_PEDIDO
   WHERE PROCODIGO='PAP'),
   
   
PED_PROMO_PLUGIN AS (SELECT ID_PEDIDPROMOCAO ID_PEDIDO_PROMO FROM PEDIDPROMO P
   INNER JOIN PD ON P.ID_PEDIDPROMOCAO=PD.ID_PEDIDO),

PED_PROMO_UNION AS (SELECT ID_PEDIDO_PROMO FROM PED_PROMO_PAP UNION
SELECT ID_PEDIDO_PROMO FROM PED_PROMO_PLUGIN)

SELECT 
PDPRD.ID_PEDIDO,
  PEDDTBAIXA,
   CLICODIGO,
    GCLCODIGO,
     SETOR,
       PROD1.PROCODIGO,
        PDPDESCRICAO,
        PEDAUTORIZOU,
          SUM(PDPQTDADE)QTD,
           SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
            CAST(50 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD1 ON PDPRD.PROCODIGO=PROD1.PROCODIGO
LEFT OUTER JOIN PED_PROMO_UNION ON PDPRD.ID_PEDIDO=PED_PROMO_UNION.ID_PEDIDO_PROMO
WHERE PED_PROMO_UNION.ID_PEDIDO_PROMO IS NULL
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION

SELECT
PDPRD.ID_PEDIDO,
  PEDDTBAIXA,
   CLICODIGO,
    GCLCODIGO,
     SETOR,
       PROD2.PROCODIGO,
        PDPDESCRICAO,
        PEDAUTORIZOU,
          SUM(PDPQTDADE)QTD,
           SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
            CAST(50 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD2 ON PDPRD.PROCODIGO=PROD2.PROCODIGO
LEFT OUTER JOIN PED_PROMO_UNION ON PDPRD.ID_PEDIDO=PED_PROMO_UNION.ID_PEDIDO_PROMO
WHERE PED_PROMO_UNION.ID_PEDIDO_PROMO IS NULL
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION

SELECT 
PDPRD.ID_PEDIDO,
  PEDDTBAIXA,
   CLICODIGO,
    GCLCODIGO,
     SETOR,
      PROD3.PROCODIGO,
        PDPDESCRICAO,
        PEDAUTORIZOU,
          SUM(PDPQTDADE)QTD,
           SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
            CAST(40 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD3 ON PDPRD.PROCODIGO=PROD3.PROCODIGO
LEFT OUTER JOIN PED_PROMO_UNION ON PDPRD.ID_PEDIDO=PED_PROMO_UNION.ID_PEDIDO_PROMO
WHERE PED_PROMO_UNION.ID_PEDIDO_PROMO IS NULL
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2 UNION


SELECT 
PDPRD.ID_PEDIDO,
  PEDDTBAIXA,
   CLICODIGO,
    GCLCODIGO,
     SETOR,
       PROD4.PROCODIGO,
        PDPDESCRICAO,
        PEDAUTORIZOU,
          SUM(PDPQTDADE)QTD,
           SUM(PDPUNITLIQUIDO*PDPQTDADE)VRVENDA,
            CAST(30 AS INTEGER) BONUS
FROM
PDPRD
INNER JOIN PD ON PDPRD.ID_PEDIDO=PD.ID_PEDIDO
INNER JOIN PROD4 ON PDPRD.PROCODIGO=PROD4.PROCODIGO
LEFT OUTER JOIN PED_PROMO_UNION ON PDPRD.ID_PEDIDO=PED_PROMO_UNION.ID_PEDIDO_PROMO
WHERE PED_PROMO_UNION.ID_PEDIDO_PROMO IS NULL
GROUP BY 1,2,3,4,5,6,7,8 HAVING SUM(PDPQTDADE)>=2
                      
 ") %>%
  mutate(CPF=sub("\\D+", '',PEDAUTORIZOU)) %>% 
  mutate(CPF=sub("\\.", '',CPF)) %>% 
  mutate(CPF=sub("\\-", '',CPF)) %>% 
  mutate(CPF=sub("\\,", '',CPF)) 

View(CP_G121_0522)

CP_G121_0522 %>% summarize(v=sum(VRVENDA))

CP_G121_0522 %>% summarize(v=sum(BONUS))

## GET CPF

BASE_CPF <- read_sheet("1ShpVwae6DVAqYW3afQli7XggL_7cJrDiWeKw2luKpC0",
                       sheet = 'DADOS') %>% select(CLICODIGO,CPF) 

## JOIN CPF

LIST_G121_0522 <- inner_join(CP_G121_0522,BASE_CPF,by="CLICODIGO") %>% 
  rename(CPF1=CPF.x) %>% rename(CPF2=CPF.y) %>% 
  mutate(OBS=paste0("G",CP_G121_0522 %>% distinct(GCLCODIGO)," ",format(floor_date(Sys.Date(),"month"),"%m/%y")))

View(LIST_G121_0522)


### pagamentos

PAG_G121_0522 <- LIST_G121_0522 %>% group_by(CPF2,CLICODIGO,GCLCODIGO) %>% 
  summarize(BONUS=round(sum(BONUS),2)) %>% 
  rename(.,"GRUPO"="GCLCODIGO") %>% 
  mutate(OBS=paste0("RINALDI ","G",CP_G121_0522 %>% distinct(GCLCODIGO)," ",format(floor_date(Sys.Date(),"month"),"%m/%y"))) %>%
  .[,c(1,4,5,2,3)]

                         

View(PAG_G121_0522)

PAG_G121_0522 %>% summarize(v=sum(BONUS))


## =============================================================================================================         
### PAGAMENTOS FINAL  


PAG_ALL_0522 <-  rbind( 
  PAG_G139_0522,
  PAG_849_0522,  ## Vital 
  PAG_157_0422 ## Dom bosco
) 

View(PAG_ALL_0522)

PAG_ALL_0422 %>% summarize(v=sum(BONUS))


sheet_write(PAG_ALL_0422,ss="1mpH2ottgRXHrTpCM0LCj9Dq-uuC4aMEsuRE5fuK7te4",sheet="PAGAMENTOS")  


